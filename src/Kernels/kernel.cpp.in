#include <mlopen/kernel.hpp>
#include <map>
#include <algorithm>
#include "mlopen_kernels.h"

namespace mlopen {

static std::string ReplaceString(std::string subject, const std::string& search, const std::string& replace) 
{
    size_t pos = 0;
    while ((pos = subject.find(search, pos)) != std::string::npos) {
         subject.replace(pos, search.length(), replace);
         pos += replace.length();
    }
    return subject;
}

static const std::map<std::string, std::string> kernels{
	${INIT_KERNELS}
};

std::string GetKernelSrc(const std::string& name)
{
    // Use the base name of the string
    int start = 0;
    auto slash = name.find_last_of("/\\");
    if (slash != std::string::npos)
    {
        start = slash + 1;
    }
    
    int len = name.size();
    auto ex = name.rfind(".");
    std::string ext;
    if (ex != std::string::npos)
    {
        ext = name.substr(ex + 1);
        len = ex - start;
    }

    auto key = name.substr(start, len);
    // Convert to uppercase
    std::transform(key.begin(), key.end(), key.begin(), ::toupper);
	std::transform(ext.begin(), ext.end(), ext.begin(), ::toupper);

    if (ext == "CL")
        return ReplaceString(kernels.at(key), "inline", "static inline");
    else
        return kernels.at(key);
}

} // namespace mlopen
